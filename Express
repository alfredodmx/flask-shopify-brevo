const express = require('express');
const axios = require('axios'); // Para enviar datos a Brevo
const app = express();
const port = 3000;

app.use(express.json()); // Para recibir datos en formato JSON

app.post('/shopify-webhook', (req, res) => {
  const data = req.body; // Datos recibidos desde Shopify
  
  // Extrae la información necesaria (ejemplo: correo electrónico del cliente)
  const customerEmail = data.customer.email;
  const customerName = data.customer.first_name + ' ' + data.customer.last_name;

  // Llamada a la API de Brevo para agregar el cliente a la lista
  sendToBrevo(customerEmail, customerName);
  
  res.status(200).send('Datos recibidos');
});

// Función para enviar los datos a Brevo
async function sendToBrevo(email, name) {
  const brevoUrl = 'https://api.sendinblue.com/v3/contacts'; // Endpoint de Brevo
  const apiKey = 'tu-api-key-de-brevo';

  const leadData = {
    email: email,
    attributes: {
      FIRSTNAME: name,
    },
    listIds: [2], // ID de la lista de contactos en Brevo
  };

  try {
    await axios.post(brevoUrl, leadData, {
      headers: {
        'api-key': apiKey,
        'Content-Type': 'application/json',
      },
    });
    console.log('Contacto agregado a Brevo');
  } catch (error) {
    console.error('Error al agregar contacto a Brevo', error);
  }
}

app.listen(port, () => {
  console.log(`Servidor escuchando en http://localhost:${port}`);
});
